<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GCC Setup Cost Calculator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/gatewai-bg.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://kit.fontawesome.com/your-fontawesome-kit.js" crossorigin="anonymous"></script>
    <style>
        /* Additional styles for the new verification modal */
        .modal-content {
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            border: none;
        }
        .modal-body {
            padding: 1.5rem;
        }
        .modal-footer {
            border-top: 1px solid #e9ecef;
            padding: 1rem 1.5rem;
        }
        .welcome-text {
            font-size: 1.1rem;
            color: #495057;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        .form-control {
            border-radius: 8px;
            padding: 0.75rem 1rem;
            border: 1px solid #ced4da;
            transition: all 0.2s;
        }
        .form-control:focus {
            border-color: #4dabf7;
            box-shadow: 0 0 0 0.2rem rgba(77, 171, 247, 0.25);
        }
        .btn-primary {
            background-color: #4dabf7;
            border-color: #4dabf7;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        .btn-primary:hover {
            background-color: #339af0;
            border-color: #339af0;
            transform: translateY(-1px);
        }
        .btn-primary:disabled {
            background-color: #a5d8ff;
            border-color: #a5d8ff;
        }
        .btn-secondary {
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 500;
        }
        .invalid-feedback {
            display: none;
            font-size: 0.875rem;
        }
        .valid-feedback {
            display: none;
            font-size: 0.875rem;
        }
        .row-gap {
            margin-bottom: 1rem;
        }
        /* Style for placeholders */
        .form-control::placeholder {
            color: #6c757d;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <!-- Gatewai Background Elements -->
    <div class="bg-animation">
        <div class="bg-circle"></div>
        <div class="bg-circle"></div>
        <div class="bg-circle"></div>
        <div class="bg-circle"></div>
        <div class="bg-circle"></div>
    </div>
    <div class="grid-overlay"></div>

    <!-- Main Container -->
    <div class="container-fluid main-container">
        {% block content %}{% endblock %}
    </div>

    <!-- Verification Modal -->
    <div class="modal fade" id="verificationModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body">
                    <p class="welcome-text">Hey! We'd like to authenticate you just once, please enter the details below to proceed.</p>
                    
                    <form id="verificationForm">
                        <div class="row row-gap">
                            <div class="col-md-6">
                                <input type="text" class="form-control" id="firstName" placeholder="First Name" required>
                            </div>
                            <div class="col-md-6">
                                <input type="text" class="form-control" id="lastName" placeholder="Last Name" required>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <input type="email" class="form-control" id="organizationEmail" 
                                   placeholder="Official Email ID" required
                                   onblur="validateOrganizationEmail(this)">
                            <div class="invalid-feedback" id="emailError">Please enter a valid organization email address.</div>
                            <div class="valid-feedback" id="emailSuccess">Valid organization email! OTP will be sent to this address.</div>
                        </div>
                        
                        <div class="mb-3">
                            <input type="text" class="form-control" id="organizationName" placeholder="Company Name" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="sendOTP()" id="sendOTPBtn" disabled>
                        Send OTP
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- OTP Verification Modal -->
    <div class="modal fade" id="otpModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <i class="fas fa-shield-alt fa-3x text-primary mb-3"></i>
                    <h4>Enter Verification Code</h4>
                    <p class="text-muted">We sent a 6-digit code to: <strong id="userEmail"></strong></p>
                    
                    <div class="mb-4">
                        <input type="text" class="form-control form-control-lg text-center fs-4" 
                               id="otpInput" maxlength="6" placeholder="000000"
                               style="letter-spacing: 10px; font-weight: bold;"
                               oninput="validateOTPInput(this)">
                        <div class="invalid-feedback" id="otpError">Invalid OTP. Please try again.</div>
                    </div>
                    
                    <p class="small text-muted">
                        Didn't receive the code? 
                        <a href="javascript:void(0)" onclick="resendOTP()" class="text-primary">Resend OTP</a>
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="verifyOTP()" id="verifyOTPBtn">
                        Verify & Continue
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentEmail = '';
        let otpAttempts = 0;
        const maxOtpAttempts = 3;

        // Personal email domains to BLOCK (only these will be rejected)
        const blockedDomains = [
            // Common personal email providers
            'gmail.com', 'googlemail.com',
            'yahoo.com', 'ymail.com', 'rocketmail.com',
            'hotmail.com', 'outlook.com', 'live.com', 'msn.com',
            'aol.com',
            'icloud.com', 'me.com', 'mac.com',
            'protonmail.com', 'proton.me',
            'zoho.com',
            'mail.com', 'email.com',
            'yandex.com', 'ya.ru',
            'gmx.com', 'gmx.net',
            'fastmail.com',
            'tutanota.com', 'tuta.io',
            'hey.com',
            'rediffmail.com',
            'indiatimes.com',
            'inbox.com', 'hushmail.com', 'lavabit.com'
        ];

        function validateOrganizationEmail(input) {
            const email = input.value.toLowerCase().trim();
            const domain = email.split('@')[1];
            
            // Basic email validation
            if (!email || !domain || !isValidEmail(email)) {
                showEmailError('Please enter a valid email address');
                return false;
            }

            // Check if domain is in blocked list (personal emails)
            const isBlocked = blockedDomains.some(blocked => domain === blocked);
            
            if (isBlocked) {
                showEmailError('Please use your company/organization email address. Personal email addresses are not allowed.');
                return false;
            }

            showEmailSuccess('Valid organization email! OTP will be sent to this address.');
            return true;
        }

        function isValidEmail(email) {
            // Basic email regex validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function showEmailError(message) {
            document.getElementById('emailError').textContent = message;
            document.getElementById('organizationEmail').classList.add('is-invalid');
            document.getElementById('organizationEmail').classList.remove('is-valid');
            document.getElementById('sendOTPBtn').disabled = true;
        }

        function showEmailSuccess(message) {
            document.getElementById('emailSuccess').textContent = message;
            document.getElementById('organizationEmail').classList.remove('is-invalid');
            document.getElementById('organizationEmail').classList.add('is-valid');
            document.getElementById('sendOTPBtn').disabled = false;
        }

        // Enhanced form validation
        function checkFormValidity() {
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const officialEmail = document.getElementById('organizationEmail').value.trim();
            const companyName = document.getElementById('organizationName').value.trim();
            
            if (firstName && lastName && officialEmail && companyName && 
                document.getElementById('organizationEmail').classList.contains('is-valid')) {
                document.getElementById('sendOTPBtn').disabled = false;
            } else {
                document.getElementById('sendOTPBtn').disabled = true;
            }
        }

        function validateOTPInput(input) {
            // Only allow numbers and auto-format
            input.value = input.value.replace(/\D/g, '').substring(0, 6);
            
            // Clear any previous error states
            input.classList.remove('is-invalid');
            document.getElementById('otpError').style.display = 'none';
        }

        async function sendOTP() {
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const email = document.getElementById('organizationEmail').value;
            const orgName = document.getElementById('organizationName').value;
            
            if (!validateOrganizationEmail(document.getElementById('organizationEmail'))) {
                return;
            }

            if (!firstName || !lastName) {
                alert('Please enter your first and last name');
                return;
            }

            if (!orgName || orgName.trim() === '') {
                alert('Please enter your organization name');
                return;
            }

            currentEmail = email;
            const btn = document.getElementById('sendOTPBtn');
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Checking...';
            btn.disabled = true;

            try {
                // First check if email is already verified
                const checkResponse = await fetch('/api/check-verification', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: email
                    })
                });

                const checkResult = await checkResponse.json();

                if (checkResponse.ok && checkResult.verified) {
                    // Email is already verified - proceed directly to calculation
                    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Proceeding...';
                    
                    // Hide verification modal
                    const verificationModal = bootstrap.Modal.getInstance(document.getElementById('verificationModal'));
                    verificationModal.hide();
                    
                    // Set flag for auto-scroll
                    sessionStorage.setItem('scrollToResults', 'true');
                    
                    // Show loading state on calculate button
                    const calculateBtn = document.querySelector('button[type="submit"]');
                    if (calculateBtn) {
                        calculateBtn.classList.add('btn-loading');
                        calculateBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Calculating...';
                        calculateBtn.disabled = true;
                    }
                    
                    // Submit the form directly
                    document.getElementById('calculator-form').submit();
                    return;
                }

                // If not verified, proceed with OTP sending
                btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Sending...';

                const response = await fetch('/api/send-otp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: email,
                        organization: orgName.trim(),
                        firstName: firstName,
                        lastName: lastName
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    if (result.already_verified) {
                        // This should not happen due to the check above, but handle it anyway
                        const verificationModal = bootstrap.Modal.getInstance(document.getElementById('verificationModal'));
                        verificationModal.hide();
                        
                        // Set flag for auto-scroll
                        sessionStorage.setItem('scrollToResults', 'true');
                        
                        // Show loading state on calculate button
                        const calculateBtn = document.querySelector('button[type="submit"]');
                        if (calculateBtn) {
                            calculateBtn.classList.add('btn-loading');
                            calculateBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Calculating...';
                            calculateBtn.disabled = true;
                        }
                        
                        document.getElementById('calculator-form').submit();
                    } else {
                        // Hide verification modal
                        const verificationModal = bootstrap.Modal.getInstance(document.getElementById('verificationModal'));
                        verificationModal.hide();
                        
                        // Show OTP modal
                        document.getElementById('userEmail').textContent = email;
                        const otpModal = new bootstrap.Modal(document.getElementById('otpModal'));
                        otpModal.show();
                        
                        // Reset OTP input and focus
                        document.getElementById('otpInput').value = '';
                        document.getElementById('otpInput').classList.remove('is-invalid');
                        document.getElementById('otpError').style.display = 'none';
                        
                        setTimeout(() => {
                            document.getElementById('otpInput').focus();
                        }, 500);
                    }
                } else {
                    alert('Error: ' + (result.error || 'Failed to send OTP'));
                }
            } catch (error) {
                console.error('OTP sending error:', error);
                alert('Failed to send OTP. Please check your connection and try again.');
            } finally {
                btn.innerHTML = 'Send OTP';
                btn.disabled = false;
            }
        }

        // Enhanced OTP verification with auto-scroll
        async function verifyOTP() {
            const otp = document.getElementById('otpInput').value;
            const btn = document.getElementById('verifyOTPBtn');

            if (otp.length !== 6) {
                showOtpError('Please enter 6-digit OTP');
                return;
            }

            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Verifying...';
            btn.disabled = true;

            try {
                const response = await fetch('/api/verify-otp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: currentEmail,
                        otp: otp
                    })
                });

                const result = await response.json();

                if (response.ok && result.verified) {
                    // OTP verified successfully
                    const otpModal = bootstrap.Modal.getInstance(document.getElementById('otpModal'));
                    otpModal.hide();
                    
                    // Set flag for auto-scroll after page reload
                    sessionStorage.setItem('scrollToResults', 'true');
                    
                    // Show loading state on calculate button
                    const calculateBtn = document.querySelector('button[type="submit"]');
                    if (calculateBtn) {
                        calculateBtn.classList.add('btn-loading');
                        calculateBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Calculating...';
                        calculateBtn.disabled = true;
                    }
                    
                    // Submit the form to calculate costs
                    document.getElementById('calculator-form').submit();
                } else {
                    otpAttempts++;
                    if (otpAttempts >= maxOtpAttempts) {
                        alert('Too many failed attempts. Please try again later.');
                        const otpModal = bootstrap.Modal.getInstance(document.getElementById('otpModal'));
                        otpModal.hide();
                    } else {
                        showOtpError('Invalid OTP. ' + (maxOtpAttempts - otpAttempts) + ' attempts remaining.');
                    }
                }
            } catch (error) {
                console.error('OTP verification error:', error);
                alert('Verification failed. Please try again.');
            } finally {
                btn.innerHTML = 'Verify & Continue';
                btn.disabled = false;
            }
        }

        function showOtpError(message) {
            const otpError = document.getElementById('otpError');
            otpError.textContent = message;
            otpError.style.display = 'block';
            document.getElementById('otpInput').classList.add('is-invalid');
        }

        function resendOTP() {
            // Reset OTP input
            document.getElementById('otpInput').value = '';
            document.getElementById('otpInput').classList.remove('is-invalid');
            document.getElementById('otpError').style.display = 'none';
            
            // Resend OTP
            sendOTP();
        }

        function showVerificationModal() {
            // Reset form state
            document.getElementById('verificationForm').reset();
            document.getElementById('organizationEmail').classList.remove('is-invalid', 'is-valid');
            document.getElementById('sendOTPBtn').disabled = true;
            
            const modal = new bootstrap.Modal(document.getElementById('verificationModal'));
            modal.show();
            
            // Focus on first name input
            setTimeout(() => {
                document.getElementById('firstName').focus();
            }, 500);
        }

        // Headcount input functions
        function updateHeadcountFromSlider(value) {
            document.getElementById('headcount-input').value = value;
            updatePlanDetailsBasedOnHeadcount(value);
        }

        function updateHeadcountFromInput(value) {
            // Ensure value is within range
            if (value < 1) value = 1;
            if (value > 1000) value = 1000;
            
            document.getElementById('headcount').value = value;
            updatePlanDetailsBasedOnHeadcount(value);
        }

        function updateHeadcountValue(value) {
            updateHeadcountFromSlider(value);
        }

        function updatePlanDetailsBasedOnHeadcount(headcount) {
            const planElement = document.getElementById('plan');
            if (planElement && typeof updatePlanDetails === 'function') {
                const currentPlan = planElement.value;
                updatePlanDetails(currentPlan, parseInt(headcount));
            }
        }

        // Enhanced scroll to results function
        function scrollToResults() {
            const resultsSection = document.getElementById('results-section');
            if (resultsSection) {
                // Add highlight animation
                resultsSection.classList.add('highlight-results');
                resultsSection.classList.add('fade-in-up');
                
                // Smooth scroll to results
                resultsSection.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start',
                    inline: 'nearest'
                });
                
                // Remove highlight after animation
                setTimeout(() => {
                    resultsSection.classList.remove('highlight-results');
                }, 2000);
            } else {
                // Fallback: try to find results by heading
                const resultsHeading = document.querySelector('h4.section-header');
                if (resultsHeading && resultsHeading.textContent.includes('Calculation Results')) {
                    const resultsCard = resultsHeading.closest('.content-card');
                    if (resultsCard) {
                        resultsCard.id = 'results-section';
                        resultsCard.classList.add('results-card');
                        scrollToResults(); // Recursive call with new ID
                    }
                }
            }
        }

        // Check if we should scroll to results on page load
        function checkAndScrollToResults() {
            const shouldScroll = sessionStorage.getItem('scrollToResults');
            if (shouldScroll === 'true') {
                // Clear the flag
                sessionStorage.removeItem('scrollToResults');
                
                // Scroll to results after a short delay to ensure page is fully loaded
                setTimeout(() => {
                    scrollToResults();
                }, 800);
            }
        }

        // Setup form submission tracking
        function setupFormSubmission() {
            const form = document.getElementById('calculator-form');
            if (form) {
                // Remove any existing event listeners to avoid duplicates
                form.removeEventListener('submit', handleFormSubmit);
                form.addEventListener('submit', handleFormSubmit);
            }
        }

        function handleFormSubmit() {
            // This will be called when form is submitted via OTP verification
            console.log('Form submitted after OTP verification');
        }

        // Enhanced DOMContentLoaded event
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize calculate button
            const calculateBtn = document.querySelector('button[type="submit"]');
            if (calculateBtn) {
                calculateBtn.setAttribute('type', 'button');
                calculateBtn.setAttribute('onclick', 'showVerificationModal()');
            }

            // Initialize headcount inputs
            const headcountInput = document.getElementById('headcount-input');
            const headcountSlider = document.getElementById('headcount');
            if (headcountInput && headcountSlider) {
                headcountInput.value = headcountSlider.value;
            }

            // Add event listeners to form fields for validation
            const formFields = document.querySelectorAll('#verificationForm input');
            formFields.forEach(field => {
                field.addEventListener('input', checkFormValidity);
            });

            // Setup form submission tracking
            setupFormSubmission();
            
            // Check if we should scroll to results
            checkAndScrollToResults();

            // Ensure results section has proper ID
            const resultsHeading = document.querySelector('h4.section-header');
            if (resultsHeading && resultsHeading.textContent.includes('Calculation Results')) {
                const resultsCard = resultsHeading.closest('.content-card');
                if (resultsCard && !resultsCard.id) {
                    resultsCard.id = 'results-section';
                    resultsCard.classList.add('results-card', 'sticky-header-offset');
                }
            }
        });

        // Add smooth scrolling for the entire page
        document.documentElement.style.scrollBehavior = 'smooth';
    </script>
</body>
</html>
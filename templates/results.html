{% extends "base.html" %}

{% block content %}
<!-- Header with Background Image and Main Logo -->
<div class="header-container" style="background-image: url('{{ url_for('static', filename='images/header-bg.jpg') }}'); background-size: cover; background-position: center; padding: 20px 0;">
    <div class="container">
        <div class="header-content text-center">
            <div class="logo-section">
                <a href="https://gatewai.io" target="_blank" class="logo-link">
                    <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Company Logo" class="company-logo">
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Title Section with Infraflex Logo Above -->
<div class="title-below-header">
    <div class="container text-center">
        <div class="infraflex-logo mb-3">
            <img src="{{ url_for('static', filename='images/logo2.png') }}" alt="Infraflex Logo" class="infraflex-logo-img">
        </div>
        <h1 class="main-header">GCC Setup Cost Calculator</h1>
    </div>
</div>

<!-- Tagline Section in One Line -->
<div class="tagline-section">
    <div class="tagline-container text-center">
        <p class="tagline">
            gatewAI's Infraflex* is a smart cost-calculator designed to help companies accurately estimate the total investment required to set up offices across Indian cities. It offers transparent insights for informed decision-making on infrastructure planning and expansion.
        </p>
    </div>
</div>

<div class="container main-container">
    <!-- Top Row: Configuration + Plan Selection + Component Selection -->
    <form id="calculator-form" method="POST" action="{{ url_for('calculate') }}">
        <div class="row g-4" style="display: flex; flex-wrap: nowrap;">
            <!-- Configuration -->
            <div class="col-md-4" style="flex: 1;">
                <div class="sidebar-card config-section">
                    <h4 class="section-header">Configuration</h4>
                    <!-- Employee Number -->
                    <div class="headcount-input-container">
                        <!-- Numeric input field with placeholder -->
                        <div class="headcount-input-field">
                            <input type="number" class="form-control" id="headcount-input" 
                                min="1" max="1000" value="100" 
                                oninput="updateHeadcountFromInput(this.value)"
                                onkeydown="return preventLargeNumbers(event)"
                                placeholder="Employee Number">
                        </div>
                        
                        <!-- Slider -->
                        <div class="headcount-slider">
                            <input type="range" class="form-range" id="headcount" name="headcount" 
                                min="1" max="1000" value="100" 
                                oninput="updateHeadcountFromSlider(this.value)">
                        </div>
                    </div>
                    
                    <!-- Tier Selection -->
                    <div class="mb-4">
                        <label for="tier" class="form-label">Select Tier</label>
                        <select class="form-select" id="tier" name="tier" onchange="updateCities()">
                            {% for tier in cities_by_tier.keys() %}
                            <option value="{{ tier }}" {% if results and results.tier == tier %}selected{% elif not results and tier == 'Tier 1' %}selected{% endif %}>{{ tier }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- City Selection -->
                    <div class="mb-4">
                        <label for="city" class="form-label">Select City</label>
                        <select class="form-select" id="city" name="city">
                            {% if results %}
                                <option value="{{ results.city }}" selected>{{ results.city }}</option>
                            {% else %}
                                {% for city in cities_by_tier['Tier 1'] %}
                                <option value="{{ city }}" {% if city == 'Bengaluru' %}selected{% endif %}>{{ city }}</option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                </div>
            </div>

            <!-- Plan Selection - Modified for vertical layout -->
            <div class="col-md-4" style="flex: 1;">
                <div class="sidebar-card">
                    <h4 class="section-header">Plan Selection</h4>
                    <div class="plan-selection-vertical mb-4">
                        <div class="plan-card-vertical plan-card basic mb-3 {% if results and results.plan == 'Basic' %}selected{% elif not results %}selected{% endif %}" id="basic-card">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6>Basic</h6>
                                    <p class="small mb-0">Essential setup</p>
                                </div>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="selectPlan('Basic')">Select</button>
                            </div>
                        </div>
                        <div class="plan-card-vertical plan-card premium mb-3 {% if results and results.plan == 'Premium' %}selected{% endif %}" id="premium-card">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6>Premium</h6>
                                    <p class="small mb-0">Enhanced features</p>
                                </div>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="selectPlan('Premium')">Select</button>
                            </div>
                        </div>
                        <div class="plan-card-vertical plan-card advance {% if results and results.plan == 'Advance' %}selected{% endif %}" id="advance-card">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6>Advance</h6>
                                    <p class="small mb-0">Fully customized</p>
                                </div>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="selectPlan('Advance')">Select</button>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="plan" name="plan" value="{{ results.plan if results else 'Basic' }}">
                </div>
            </div>

            <!-- Component Selection - Updated to match Plan Selection style -->
            <div class="col-md-4" style="flex: 1;">
                <div class="sidebar-card">
                    <h4 class="section-header">Component Selection</h4>
                    <div class="component-selection-vertical mb-4">
                        <div class="component-card-vertical mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6>Real Estate</h6>
                                    <p class="small mb-0">Office space & facilities</p>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="real_estate" name="real_estate" {% if results and results.real_estate_toggle %}checked{% elif not results %}checked{% endif %}>
                                </div>
                            </div>
                        </div>
                        <div class="component-card-vertical mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6>IT Infrastructure</h6>
                                    <p class="small mb-0">Hardware, networking & security</p>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="it_infra" name="it_infra" {% if results and results.it_infra_toggle %}checked{% elif not results %}checked{% endif %}>
                                </div>
                            </div>
                        </div>
                        <div class="component-card-vertical mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6>Enabling Functions</h6>
                                    <p class="small mb-0">HR, Finance & Admin</p>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="enabling" name="enabling" {% if results and results.enabling_toggle %}checked{% elif not results %}checked{% endif %}>
                                </div>
                            </div>
                        </div>
                        <div class="component-card-vertical">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6>Software Licensing Fee</h6>
                                    <p class="small mb-0">Applications & platforms</p>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="technology" name="technology" {% if results and results.technology_toggle %}checked{% elif not results %}checked{% endif %}>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Calculate Cost</button>
                </div>
            </div>
        </div>
    </form>

    <!-- Bottom Row: Calculation Results (Left) + Plan Details (Right) -->
    <div class="row g-4 mt-3" style="display: flex; flex-wrap: nowrap;">
        <!-- Calculation Results - Added ID for auto-scrolling -->
        <div class="col-md-8" style="flex: 2;">
            <div class="content-card" id="results-section">
                <h4 class="section-header">Calculation Results</h4>
                
                {% if results %}
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="metric-card">
                            <h6 class="tooltip-heading">
                                Total Monthly Cost (INR)
                                <span class="tooltip-indicator" data-bs-toggle="tooltip" 
                                      title="This is the ballpark figure; the actual number will vary based on the selection of asset class, IT infrastructure, number of employees in enabling functions, and final selection of software licensing.">
                                    *
                                </span>
                            </h6>
                            <h2 class="orange-text">₹{{ "{:,.0f}".format(results.total_cost) }}</h2>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="metric-card">
                            <h6 class="tooltip-heading">
                                Cost (USD/hour/head)
                                <span class="tooltip-indicator" data-bs-toggle="tooltip" 
                                      title="This is the ballpark figure; the actual number will vary based on the selection of asset class, IT infrastructure, number of employees in enabling functions, and final selection of software licensing.">
                                    *
                                </span>
                            </h6>
                            <h2 class="orange-text">${{ "%.2f"|format(results.hourly_cost_per_head_usd) }}</h2>
                        </div>
                    </div>
                </div>
                
                <h6>Cost Breakdown (Monthly):</h6>
                <div class="row">
                    <div class="col-md-6">
                        <ul class="list-unstyled">
                            {% if results.real_estate_toggle %}
                            <li><strong>Real Estate:</strong> ₹{{ "{:,.0f}".format(results.total_real_estate_cost) }}</li>
                            {% endif %}
                            {% if results.it_infra_toggle %}
                            <li><strong>IT Infrastructure:</strong> ₹{{ "{:,.0f}".format(results.total_it_infra_cost) }}</li>
                            {% endif %}
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul class="list-unstyled">
                            {% if results.enabling_toggle %}
                            <li><strong>Enabling Functions:</strong> ₹{{ "{:,.0f}".format(results.enab_cost) }}</li>
                            {% endif %}
                            {% if results.technology_toggle %}
                            <li><strong>Software Licensing:</strong> ₹{{ "{:,.0f}".format(results.tech_cost) }}</li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
                
                <h6 class="mt-4">Configuration:</h6>
                <p>Headcount: {{ results.headcount }} | City: {{ results.city }} ({{ results.tier }}) | Plan: {{ results.plan }}</p>

                <div class="mt-4">
                    <button class="btn btn-primary" onclick="downloadReport()">
                        <i class="fas fa-download me-2"></i>Download Report
                    </button>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <div class="alert alert-info">
                        <h5>No Calculation Results Yet</h5>
                        <p class="mb-0">Please configure your settings above and click "Calculate Cost" to see the results.</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Plan Details -->
        <div class="col-md-4" style="flex: 1;">
            <div class="content-card">
                <h4 class="section-header">Plan Details</h4>
                {% if results %}
                <h5 id="plan-name">{{ results.plan_details.name }}</h5>
                <p id="plan-description" class="fst-italic">{{ results.plan_details.description }}</p>
                <h6>Components Included:</h6>
                <ul class="list-unstyled">
                    <li><strong>Real Estate:</strong> <span id="plan-real-estate">{{ results.plan_details.real_estate }}</span></li>
                    <li><strong>IT Infrastructure:</strong> <span id="plan-it-infra">{{ results.plan_details.it_infra }}</span></li>
                    <li><strong>Enabling Functions:</strong> <span id="plan-enabling-functions">{{ results.plan_details.enabling_functions }}</span></li>
                    <li><strong>Technology:</strong> <span id="plan-technology">{{ results.plan_details.technology }}</span></li>
                </ul>
                {% else %}
                <h5 id="plan-name">Basic Plan</h5>
                <p id="plan-description" class="fst-italic">Essential GCC setup with core functionality</p>
                <h6>Components Included:</h6>
                <ul class="list-unstyled">
                    <li><strong>Real Estate:</strong> <span id="plan-real-estate">Managed Workspace</span></li>
                    <li><strong>IT Infrastructure:</strong> <span id="plan-it-infra">Hardware, Networking, Security solutions, Cloud, IT Support, Collaboration tools, Data-centre, Disaster-recovery backups, Compliance & audits, End-user peripherals, cybersecurity (SIEM/DLP), Biometric attendance/access</span></li>
                    <li><strong>Enabling Functions:</strong> <span id="plan-enabling-functions">HR/Admin (1), Finance (1), IT Support (1) (2–3 FTEs)</span></li>
                    <li><strong>Technology:</strong> <span id="plan-technology">Zoho People (HRIS ₹3,000), Zoho Recruit (ATS ₹1,500), Zoho Books Std (Finance ₹749), Google Workspace/Slack (₹500)</span></li>
                </ul>
                {% endif %}
                <div class="alert alert-info">
                    Note: Premium/Advance plans may increase totals by 3–5% depending on modules and customizations.
                </div>
            </div>
        </div>
    </div>
</div>

<hr class="my-5">

<!-- Footer -->
<div class="row">
    <div class="col-12 text-center "> *The cost estimates provided by Infraflex are indicative and approximate. 
        Actual costs may vary depending on location, vendor negotiations, and other factors.</div>
    <div class="col-12 text-center footer">
        <p>GCC Setup Cost Calculator v1.0</p>
    </div>
</div>

<!-- Add some custom CSS for the vertical plan cards -->
<style>
    .plan-selection-vertical {
        display: flex;
        flex-direction: column;
        gap: 15px;
        width: 100%;
    }

    .plan-card-vertical {
        width: 100%;
        padding: 11px;
        border: 1px solid #ddd;
        border-radius: 8px;
        transition: all 0.3s ease;
        cursor: pointer;
        box-sizing: border-box;
    }

    .plan-card-vertical.selected {
        border-color: #0d6efd;
        background-color: rgba(13, 110, 253, 0.05);
    }

    .plan-card-vertical:hover {
        background-color: #f8f9fa;
    }

    /* Component Selection Styles to match Plan Selection */
    .component-selection-vertical {
        display: flex;
        flex-direction: column;
    }

    .component-card-vertical {
        padding: 3px;
        border: 1px solid #ddd;
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .component-card-vertical:hover {
        background-color: #f8f9fa;
        border-color: #FFE4D6;
    }

    .component-card-vertical h6 {
        margin-bottom: 2px;
        color: #333;
        font-size: 0.95rem;
        font-weight: 600;
    }

    .component-card-vertical .small {
        color: #666;
        font-size: 0.8rem;
        margin-bottom: 0;
    }

    /* Form switch customization */
    .component-card-vertical .form-check-input {
        width: 2.8em;
        height: 1.5em;
    }

    .component-card-vertical .form-check-input:checked {
        background-color: #FF7F41;
        border-color: #FF7F41;
    }

    /* Ensure consistent spacing */
    .component-selection-vertical.mb-4 {
        margin-bottom: 1.5rem !important;
    }

    /* Highlight animation for results section */
    .highlight-results {
        animation: highlightPulse 2s ease-in-out;
    }

    @keyframes highlightPulse {
        0% {
            background-color: transparent;
            box-shadow: 0 4px 12px rgba(255, 127, 65, 0.1);
        }
        50% {
            background-color: rgba(255, 127, 65, 0.05);
            box-shadow: 0 8px 25px rgba(255, 127, 65, 0.2);
            transform: translateY(-5px);
        }
        100% {
            background-color: transparent;
            box-shadow: 0 4px 12px rgba(255, 127, 65, 0.1);
            transform: translateY(0);
        }
    }

    /* Fade-in animation */
    .fade-in-up {
        opacity: 0;
        transform: translateY(30px);
        animation: fadeInUp 0.8s ease forwards;
    }

    @keyframes fadeInUp {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Smooth scrolling */
    html {
        scroll-behavior: smooth;
    }

    /* Sticky header adjustment */
    .sticky-header-offset {
        scroll-margin-top: 120px;
    }

    /* Tooltip styling for cost metrics */
    .tooltip-heading {
        position: relative;
        display: inline-block;
    }

    .tooltip-indicator {
        color: #FF7F41;
        cursor: pointer;
        font-weight: bold;
        margin-left: 4px;
        font-size: 1.1em;
        vertical-align: super;
    }

    .tooltip-indicator:hover {
        color: #e56a2e;
    }

    /* Custom tooltip styling */
    .tooltip {
        font-family: 'Inter', sans-serif;
    }

    .tooltip .tooltip-inner {
        background-color: #333;
        color: white;
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 0.9rem;
        max-width: 300px;
        text-align: left;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .tooltip.bs-tooltip-top .tooltip-arrow::before {
        border-top-color: #333;
    }

    .tooltip.bs-tooltip-bottom .tooltip-arrow::before {
        border-bottom-color: #333;
    }

    .tooltip.bs-tooltip-start .tooltip-arrow::before {
        border-left-color: #333;
    }

    .tooltip.bs-tooltip-end .tooltip-arrow::before {
        border-right-color: #333;
    }
</style>

<script>
    // Cities data for each tier
    const citiesByTier = {{ cities_by_tier | tojson }};

    // Plan details configuration based on headcount range and plan
    const planDetailsByHeadcount = {
        'Basic': {
            '0-50': {
                name: 'Basic Plan',
                description: 'Essential GCC setup with core functionality',
                real_estate: 'Managed Workspace',
                it_infra: 'Hardware, Networking, Security solutions, Cloud, IT Support, Collaboration tools, Data-centre, Disaster-recovery backups, Compliance & audits, End-user peripherals, cybersecurity (SIEM/DLP), Biometric attendance/access',
                enabling_functions: 'HR/Admin , Finance , IT Support ',
                technology: 'Zoho People , Zoho Recruit , Zoho Books Std , Google Workspace/Slack '
            },
            '51-100': {
                name: 'Basic Plan',
                description: 'Essential GCC setup with core functionality',
                real_estate: 'Managed Workspace',
                it_infra: 'Hardware, Networking, Security solutions, Cloud, IT Support, Collaboration tools, Data-centre, Disaster-recovery backups, Compliance & audits, End-user peripherals, cybersecurity (SIEM/DLP), Biometric attendance/access',
                enabling_functions: 'HR , Finance , Admin , IT Helpdesk ',
                technology: 'Keka (HR+Payroll), QuickBooks Advanced , Slack/Workspace '
            },
            '101-250': {
                name: 'Basic Plan',
                description: 'Essential GCC setup with core functionality',
                real_estate: 'Managed Workspace',
                it_infra: 'Hardware, Networking, Security solutions, Cloud, IT Support, Collaboration tools, Data-centre, Disaster-recovery backups, Compliance & audits, End-user peripherals, cybersecurity (SIEM/DLP), Biometric attendance/access',
                enabling_functions: 'HR , Finance , Admin , IT ',
                technology: 'Darwinbox , Zoho Books Pro , Slack/Workspace '
            },
            '251-500': {
                name: 'Basic Plan',
                description: 'Essential GCC setup with core functionality',
                real_estate: 'Managed Workspace',
                it_infra: 'Hardware, Networking, Security solutions, Cloud, IT Support, Collaboration tools, Data-centre, Disaster-recovery backups, Compliance & audits, End-user peripherals, cybersecurity (SIEM/DLP), Biometric attendance/access',
                enabling_functions: 'HRBP + Ops , Finance , Admin , IT ',
                technology: 'Darwinbox , NetSuite ERP , Slack '
            },
            '501-1000': {
                name: 'Basic Plan',
                description: 'Essential GCC setup with core functionality',
                real_estate: 'Managed Workspace',
                it_infra: 'Hardware, Networking, Security solutions, Cloud, IT Support, Collaboration tools, Data-centre, Disaster-recovery backups, Compliance & audits, End-user peripherals, cybersecurity (SIEM/DLP), Biometric attendance/access',
                enabling_functions: 'Full Enabling COEs with Mid Mgmt layers (HR, Finance, Admin, IT) ',
                technology: 'SAP SuccessFactors , SAP B1/Oracle ERP , Slack '
            }
        },
        'Premium': {
            '0-50': {
                name: 'Premium Plan',
                description: 'Enhanced GCC setup with additional features',
                real_estate: 'Managed Workspace',
                it_infra: 'Hardware, Networking, Security solutions, Cloud/SaaS, IT Support & AMC, Collaboration tools, Data-centre/Colocation, Disaster-recovery backups, Compliance & audits, End-user peripherals, Advanced cybersecurity (SIEM/DLP), Biometric attendance/access',
                enabling_functions: 'Marketing , Legal , Finance/Vendor Mgmt ',
                technology: 'Zoho People , Zoho Recruit , Zoho Books Std , Zoho Campaigns , Zoho Contracts , Slack/Workspace '
            },
            '51-100': {
                name: 'Premium Plan',
                description: 'Enhanced GCC setup with additional features',
                real_estate: 'Managed Workspace',
                it_infra: 'Hardware, Networking, Security solutions, Cloud/SaaS, IT Support & AMC, Collaboration tools, Data-centre/Colocation, Disaster-recovery backups, Compliance & audits, End-user peripherals, Advanced cybersecurity (SIEM/DLP), Biometric attendance/access',
                enabling_functions: 'Marketing , Legal , Finance/Vendor Mgmt , Other ',
                technology: 'Keka , QuickBooks Adv , HubSpot Starter , Zoho Contracts , Slack/Workspace '
            },
            '101-250': {
                name: 'Premium Plan',
                description: 'Enhanced GCC setup with additional features',
                real_estate: 'Managed Workspace',
                it_infra: 'Hardware, Networking, Security solutions, Cloud/SaaS, IT Support & AMC, Collaboration tools, Data-centre/Colocation, Disaster-recovery backups, Compliance & audits, End-user peripherals, Advanced cybersecurity (SIEM/DLP), Biometric attendance/access',
                enabling_functions: 'Marketing , Legal , Finance/Vendor Mgmt , Other ',
                technology: 'Darwinbox , Zoho Books Pro , HubSpot Pro , DocuSign CLM , Slack '
            },
            '251-500': {
                name: 'Premium Plan',
                description: 'Enhanced GCC setup with additional features',
                real_estate: 'Managed Workspace',
                it_infra: 'Hardware, Networking, Security solutions, Cloud/SaaS, IT Support & AMC, Collaboration tools, Data-centre/Colocation, Disaster-recovery backups, Compliance & audits, End-user peripherals, Advanced cybersecurity (SIEM/DLP), Biometric attendance/access',
                enabling_functions: 'Marketing , Legal , Finance/Vendor Mgmt , Other ',
                technology: 'Darwinbox , NetSuite ERP , HubSpot Pro , DocuSign CLM , Slack '
            },
            '501-1000': {
                name: 'Premium Plan',
                description: 'Enhanced GCC setup with additional features',
                real_estate: 'Managed Workspace',
                it_infra: 'Hardware, Networking, Security solutions, Cloud/SaaS, IT Support & AMC, Collaboration tools, Data-centre/Colocation, Disaster-recovery backups, Compliance & audits, End-user peripherals, Advanced cybersecurity (SIEM/DLP), Biometric attendance/access',
                enabling_functions: 'Marketing , Legal , Finance/Vendor Mgmt , Other ',
                technology: 'SAP SuccessFactors , SAP B1/Oracle ERP , Salesforce Marketing Cloud , DocuSign CLM , Slack '
            }
        },
        'Advance': {
            '0-50': {
                name: 'Advance Plan',
                description: 'Comprehensive GCC setup with full customization',
                real_estate: 'Managed Workspace',
                it_infra: 'Hardware, Networking, Security solutions, Cloud/SaaS, IT Support & AMC, Collaboration tools, Data-centre/Colocation, Disaster-recovery backups, Compliance & audits, End-user peripherals, Advanced cybersecurity (SIEM/DLP), Biometric attendance/access',
                enabling_functions: 'Marketing , Legal , Finance , Vendor Mgmt ',
                technology: 'Keka , QuickBooks Adv , HubSpot Starter , DocuSign CLM , Slack + Notion '
            },
            '51-100': {
                name: 'Advance Plan',
                description: 'Comprehensive GCC setup with full customization',
                real_estate: 'Managed Workspace',
                it_infra: 'Hardware, Networking, Security solutions, Cloud/SaaS, IT Support & AMC, Collaboration tools, Data-centre/Colocation, Disaster-recovery backups, Compliance & audits, End-user peripherals, Advanced cybersecurity (SIEM/DLP), Biometric attendance/access',
                enabling_functions: 'Marketing , Legal , Finance/Vendor Mgmt , Other ',
                technology: 'Darwinbox , QuickBooks Adv , HubSpot Pro , DocuSign CLM , Slack + Notion '
            },
            '101-250': {
                name: 'Advance Plan',
                description: 'Comprehensive GCC setup with full customization',
                real_estate: 'Managed Workspace',
                it_infra: 'Hardware, Networking, Security solutions, Cloud/SaaS, IT Support & AMC, Collaboration tools, Data-centre/Colocation, Disaster-recovery backups, Compliance & audits, End-user peripherals, Advanced cybersecurity (SIEM/DLP), Biometric attendance/access',
                enabling_functions: 'Marketing , Legal , Finance/Vendor Mgmt , Other ',
                technology: 'Darwinbox , NetSuite ERP , Marketo Pro , DocuSign CLM , Slack + Notion '
            },
            '251-500': {
                name: 'Advance Plan',
                description: 'Comprehensive GCC setup with full customization',
                real_estate: 'Managed Workspace',
                it_infra: 'Hardware, Networking, Security solutions, Cloud/SaaS, IT Support & AMC, Collaboration tools, Data-centre/Colocation, Disaster-recovery backups, Compliance & audits, End-user peripherals, Advanced cybersecurity (SIEM/DLP), Biometric attendance/access',
                enabling_functions: 'Marketing , Legal , Finance/Vendor Mgmt , Other ',
                technology: 'SAP SuccessFactors , SAP B1 ERP , Marketo Pro , Agiloft CLM , Slack Grid + Notion '
            },
            '501-1000': {
                name: 'Advance Plan',
                description: 'Comprehensive GCC setup with full customization',
                real_estate: 'Managed Workspace',
                it_infra: 'Hardware, Networking, Security solutions, Cloud/SaaS, IT Support & AMC, Collaboration tools, Data-centre/Colocation, Disaster-recovery backups, Compliance & audits, End-user peripherals, Advanced cybersecurity (SIEM/DLP), Biometric attendance/access',
                enabling_functions: 'Marketing , Legal , Finance/Vendor Mgmt , Other ',
                technology: 'SAP SuccessFactors , Oracle ERP Cloud , Salesforce Marketing Cloud , Agiloft CLM , Slack Grid + Notion '
            }
        }
    };

    // Update plan details based on selected plan and headcount
    function updatePlanDetails(plan, headcount) {
        // Get headcount range
        let headcountRange;
        if (headcount <= 50) headcountRange = '0-50';
        else if (headcount <= 100) headcountRange = '51-100';
        else if (headcount <= 250) headcountRange = '101-250';
        else if (headcount <= 500) headcountRange = '251-500';
        else headcountRange = '501-1000';

        // Get the details for current plan and headcount range
        const details = planDetailsByHeadcount[plan][headcountRange];
        
        // Update the UI
        document.getElementById('plan-name').textContent = details.name;
        document.getElementById('plan-description').textContent = details.description;
        document.getElementById('plan-real-estate').textContent = details.real_estate;
        document.getElementById('plan-it-infra').textContent = details.it_infra;
        document.getElementById('plan-enabling-functions').textContent = details.enabling_functions;
        document.getElementById('plan-technology').textContent = details.technology;
    }

    function updateHeadcountValue(value) {
        document.getElementById('headcount-value').textContent = value;
        
        // Get current plan and update plan details
        const plan = document.getElementById('plan').value;
        updatePlanDetails(plan, parseInt(value));
    }
    
    function updateCities() {
        const tier = document.getElementById('tier').value;
        const citySelect = document.getElementById('city');
        const currentCity = citySelect.value;
        
        // Clear existing options
        citySelect.innerHTML = '';
        
        // Add new options
        citiesByTier[tier].forEach(city => {
            const option = document.createElement('option');
            option.value = city;
            option.textContent = city;
            
            // Preselect the current city if it exists in the new tier
            if (city === currentCity) {
                option.selected = true;
            }
            
            citySelect.appendChild(option);
        });
        
        // If current city doesn't exist in the new tier, select the first city
        if (!citiesByTier[tier].includes(currentCity)) {
            citySelect.selectedIndex = 0;
        }
    }
    
    function selectPlan(plan) {
        document.getElementById('plan').value = plan;
        
        // Update UI
        const planCards = document.querySelectorAll('.plan-card-vertical');
        planCards.forEach(card => {
            card.classList.remove('selected');
        });
        
        document.getElementById(`${plan.toLowerCase()}-card`).classList.add('selected');
        
        // Get current headcount and update plan details
        const headcount = parseInt(document.getElementById('headcount').value);
        updatePlanDetails(plan, headcount);
    }

    // Function to prevent typing numbers larger than 1000
    function preventLargeNumbers(event) {
        // Allow backspace, delete, tab, escape, enter, and decimal point
        if ([46, 8, 9, 27, 13, 110, 190].indexOf(event.keyCode) !== -1 ||
            // Allow: Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
            (event.keyCode === 65 && event.ctrlKey === true) ||
            (event.keyCode === 67 && event.ctrlKey === true) ||
            (event.keyCode === 86 && event.ctrlKey === true) ||
            (event.keyCode === 88 && event.ctrlKey === true) ||
            // Allow: home, end, left, right
            (event.keyCode >= 35 && event.keyCode <= 39)) {
            return;
        }
        
        // Ensure that it is a number and stop the keypress if it would create a value > 1000
        if ((event.shiftKey || (event.keyCode < 48 || event.keyCode > 57)) && 
            (event.keyCode < 96 || event.keyCode > 105)) {
            event.preventDefault();
            return;
        }
        
        // Get the current value and the new potential value
        const input = event.target;
        const currentValue = input.value;
        const newValue = currentValue + String.fromCharCode(event.keyCode);
        
        // Check if the new value would be greater than 1000
        if (parseInt(newValue) > 1000) {
            event.preventDefault();
            return false;
        }
    }

    // Enhanced function to update headcount from input with validation
    function updateHeadcountFromInput(value) {
        // Ensure value is within range
        if (value < 1) value = 1;
        if (value > 1000) {
            value = 1000;
            // Update the input field to show the clamped value
            document.getElementById('headcount-input').value = value;
        }
        
        document.getElementById('headcount').value = value;
        updatePlanDetailsBasedOnHeadcount(value);
    }

    function updateHeadcountFromSlider(value) {
        document.getElementById('headcount-input').value = value;
        updatePlanDetailsBasedOnHeadcount(value);
    }

    function updatePlanDetailsBasedOnHeadcount(headcount) {
        const planElement = document.getElementById('plan');
        if (planElement && typeof updatePlanDetails === 'function') {
            const currentPlan = planElement.value;
            updatePlanDetails(currentPlan, parseInt(headcount));
        }
    }

    // Initialize plan details on page load
    document.addEventListener('DOMContentLoaded', function() {
        const initialHeadcount = parseInt(document.getElementById('headcount').value);
        const initialPlan = document.getElementById('plan').value;
        updatePlanDetails(initialPlan, initialHeadcount);
        
        // Set the selected plan card
        const planCards = document.querySelectorAll('.plan-card-vertical');
        planCards.forEach(card => {
            card.classList.remove('selected');
        });
        document.getElementById(`${initialPlan.toLowerCase()}-card`).classList.add('selected');

        // Initialize Bootstrap tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });

        // Check if we should auto-scroll to results (after OTP verification)
        const shouldScroll = sessionStorage.getItem('scrollToResults');
        if (shouldScroll === 'true') {
            // Clear the flag
            sessionStorage.removeItem('scrollToResults');
            
            // Scroll to results after a short delay to ensure page is fully loaded
            setTimeout(() => {
                const resultsSection = document.getElementById('results-section');
                if (resultsSection) {
                    // Add highlight animation
                    resultsSection.classList.add('highlight-results');
                    resultsSection.classList.add('fade-in-up');
                    
                    // Smooth scroll to results
                    resultsSection.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start',
                        inline: 'nearest'
                    });
                    
                    // Remove highlight after animation
                    setTimeout(() => {
                        resultsSection.classList.remove('highlight-results');
                    }, 2000);
                }
            }, 800);
        }

        // Add event listener for input changes to enforce max value
        document.getElementById('headcount-input').addEventListener('input', function() {
            if (this.value > 1000) {
                this.value = 1000;
            }
        });
    });
    
    function downloadReport() {
        {% if results %}
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // ✅ Safely embed values as numbers
        const totalCost = {{ results.total_cost|tojson }};
        const usdCost = {{ results.hourly_cost_per_head_usd|tojson }};
        const realEstate = {{ results.total_real_estate_cost|tojson }};
        const itInfra = {{ results.total_it_infra_cost|tojson }};
        const enabling = {{ results.enab_cost|tojson }};
        const technology = {{ results.tech_cost|tojson }};

        // ---------- IMAGE PATHS ----------
        const headerImg = "{{ url_for('static', filename='images/pdf_header.png') }}";
        const footerImg = "{{ url_for('static', filename='images/pdf_footer.jpeg') }}";

        // Define margins and dimensions
        const pageWidth = 210; // A4 width in mm
        const leftMargin = 15;
        const rightMargin = 15;
        const headerHeight = 45; // Increased header height
        const footerHeight = 20;
        const contentWidth = pageWidth - leftMargin - rightMargin;

        function addHeaderFooter() {
            const pageCount = doc.internal.getNumberOfPages();
            
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);

                // Header image - full width with increased height
                doc.addImage(headerImg, "PNG", leftMargin, 5, contentWidth, headerHeight);

                // Footer image - full width with proper margins
                const footerY = doc.internal.pageSize.height - footerHeight - 10;
                doc.addImage(footerImg, "JPEG", leftMargin, footerY, contentWidth, footerHeight);
            }
        }

        // ---------- CONFIGURATION DETAILS ----------
        const startY = 60; // Increased space between header and content
        
        doc.setFontSize(14);
        doc.setTextColor(40, 40, 40);
        doc.text("Configuration Details", leftMargin, startY);

        const configData = [
            ["Headcount", "{{ results.headcount }}"],
            ["City", "{{ results.city }}"],
            ["Tier", "{{ results.tier }}"],
            ["Plan", "{{ results.plan }}"],
        ];

        doc.autoTable({
            startY: startY + 5,
            head: [["Parameter", "Value"]],
            body: configData,
            theme: 'grid',
            styles: { fontSize: 11, cellPadding: 3 },
            headStyles: { fillColor: [255, 127, 65], textColor: 255, fontStyle: 'bold' },
            margin: { left: leftMargin, right: rightMargin },
            tableWidth: contentWidth
        });

        // ---------- COST SUMMARY ----------
        let finalY = doc.lastAutoTable.finalY + 15;
        doc.setFontSize(14);
        doc.setTextColor(40, 40, 40);
        doc.text("Cost Summary", leftMargin, finalY);

        const costSummaryData = [
            ["Total Monthly Cost (INR)", "Rs. " + totalCost.toLocaleString("en-IN")],
            ["Cost (USD/hour/head)", "$" + usdCost.toFixed(2)],
        ];

        doc.autoTable({
            startY: finalY + 5,
            head: [["Metric", "Value"]],
            body: costSummaryData,
            theme: 'grid',
            styles: { fontSize: 11, cellPadding: 3 },
            headStyles: { fillColor: [52, 152, 219], textColor: 255, fontStyle: 'bold' },
            margin: { left: leftMargin, right: rightMargin },
            tableWidth: contentWidth
        });

        // ---------- COST BREAKDOWN ----------
        finalY = doc.lastAutoTable.finalY + 15;
        doc.setFontSize(14);
        doc.setTextColor(40, 40, 40);
        doc.text("Cost Breakdown (Monthly)", leftMargin, finalY);

        const tableData = [];
        {% if results.real_estate_toggle %}
        tableData.push(["Real Estate", "Rs. " + realEstate.toLocaleString("en-IN")]);
        {% endif %}
        {% if results.it_infra_toggle %}
        tableData.push(["IT Infrastructure", "Rs. " + itInfra.toLocaleString("en-IN")]);
        {% endif %}
        {% if results.enabling_toggle %}
        tableData.push(["Enabling Functions", "Rs. " + enabling.toLocaleString("en-IN")]);
        {% endif %}
        {% if results.technology_toggle %}
        tableData.push(["Software Licensing", "Rs. " + technology.toLocaleString("en-IN")]);
        {% endif %}

        // ✅ Add Grand Total row
        tableData.push(["Grand Total", "Rs. " + totalCost.toLocaleString("en-IN")]);

        doc.autoTable({
            startY: finalY + 5,
            head: [["Component", "Cost (INR)"]],
            body: tableData,
            theme: 'grid',
            styles: { fontSize: 11, cellPadding: 3 },
            headStyles: { fillColor: [46, 204, 113], textColor: 255, fontStyle: 'bold' },
            columnStyles: { 0: { fontStyle: "bold" }, 1: { fontStyle: "bold" } },
            margin: { left: leftMargin, right: rightMargin },
            tableWidth: contentWidth
        });

        // ---------- FOOTER PAGE NUMBER ----------
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            doc.setFontSize(9);
            doc.setTextColor(120, 120, 120);
            
            // Position page number above footer
            const pageNumY = doc.internal.pageSize.height - footerHeight - 15;
            doc.text(`Page ${i} of ${pageCount}`, pageWidth / 2, pageNumY, { align: "center" });
        }

        // ✅ Add header & footer images AFTER all content
        addHeaderFooter();

        // ---------- SAVE ----------
        const now = new Date();
        const timestamp = now.toISOString().replace(/[-:]/g, '').split('.')[0];
        doc.save(`gcc_cost_report_${timestamp}.pdf`);
        {% else %}
        alert('Please calculate costs first before downloading the report.');
        {% endif %}
    }
</script>
{% endblock %}